#!/bin/bash

# Dynamically generated by Puppet
# Local modifications will be over-written

# This is a Cobbler trigger script that triggers a replication on the slave
# server. You need to create a private/public key-pair on the master and
# add the public key to ~/.ssh/authorized_keys on the slave

<% if role == "primary" %>
ssh -t -t -oStrictHostKeyChecking=no -oBatchMode=yes -i <%= @replication_pkey_path %> <%= @replication_user %>@<%= @secondary_server_ip %> "/usr/bin/sudo /usr/local/bin/cobbler-replicate"
<% elsif role == "secondary" %>
/bin/ps auxwwwwww | /bin/grep -v grep | /bin/grep -q "cobbler replicate"
if [ $? -eq 1 ]; then
  /usr/bin/sudo /usr/bin/cobbler replicate --master=<%= @primary_server_ip %> --sync-all --prune --distros=* --profiles=* --systems=* --repos=* --image=* --mgmtclasses=* --packages=* --files=* && /usr/bin/sudo /usr/bin/cobbler sync
else
  echo "Replication already in progress. Skipping."
fi
<% end %>
